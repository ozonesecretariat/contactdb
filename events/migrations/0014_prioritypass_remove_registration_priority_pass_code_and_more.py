# Generated by Django 5.2.1 on 2025-07-01 08:09

import django.db.models.deletion
import django_extensions.db.fields
from django.db import migrations, models


def migrate_priority_pass(apps, schema_editor):
    registration_model = apps.get_model("events", "Registration")
    pass_model = apps.get_model("events", "PriorityPass")
    db_alias = schema_editor.connection.alias

    # Move priority pass codes to the new model
    for obj in registration_model.objects.using(db_alias).all():
        if obj.priority_pass_code:
            priority_pass, created = pass_model.objects.using(db_alias).get_or_create(
                code=obj.priority_pass_code,
            )
        else:
            priority_pass = pass_model.objects.using(db_alias).create()

        obj.priority_pass = priority_pass
        obj.save()

        if priority_pass.registrations.distinct("contact").count() > 1:
            raise RuntimeError(
                f"Invalid priority pass code for contact: {obj.priority_pass_code}"
            )


def migrate_event_groups(apps, schema_editor):
    event_model = apps.get_model("events", "Event")
    db_alias = schema_editor.connection.alias

    for event in event_model.objects.using(db_alias).filter(groups__isnull=False):
        event.group = event.groups.first()
        event.save()


class Migration(migrations.Migration):
    dependencies = [
        ("events", "0013_alter_registration_designation"),
    ]

    operations = [
        migrations.CreateModel(
            name="PriorityPass",
            options={
                "verbose_name": "priority pass",
                "verbose_name_plural": "priority passes",
            },
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "code",
                    django_extensions.db.fields.RandomCharField(
                        blank=True,
                        editable=False,
                        length=10,
                        unique=True,
                        uppercase=True,
                    ),
                ),
            ],
        ),
        migrations.AddField(
            model_name="event",
            name="attach_priority_pass",
            field=models.BooleanField(
                default=False,
                help_text="Automatically attach priority pass to the accredited confirmation email",
            ),
        ),
        migrations.AddField(
            model_name="registration",
            name="priority_pass",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="registrations",
                to="events.prioritypass",
            ),
        ),
        migrations.RunPython(migrate_priority_pass, migrations.RunPython.noop),
        migrations.RemoveField(
            model_name="registration",
            name="priority_pass_code",
        ),
        migrations.AddField(
            model_name="event",
            name="group",
            field=models.ForeignKey(
                blank=True,
                help_text="Group linking related events",
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name="events",
                to="events.eventgroup",
            ),
        ),
        migrations.RunPython(migrate_event_groups, migrations.RunPython.noop),
        migrations.RemoveField(
            model_name="event",
            name="groups",
        ),
    ]
